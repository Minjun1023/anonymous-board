<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>1:1 대화</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #chat-box {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
        }
        .message {
            margin-bottom: 10px;
        }
        .sent {
            text-align: right;
        }
        .received {
            text-align: left;
        }
        .system-message {
            text-align: center;
            color: #888;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/layout :: navigation}"></div>

    <div class="container mt-4">
        <h2 th:text="|${receiver.nickname}님과의 대화|">대화</h2>
        <div id="chat-box">
            <!-- Messages will be loaded here -->
        </div>
        <form id="messageForm" class="mt-3">
            <div class="input-group">
                <input type="text" id="messageContent" class="form-control" placeholder="메시지 입력..." required>
                <button type="submit" class="btn btn-primary">전송</button>
            </div>
        </form>
    </div>

    <div th:replace="~{fragments/layout :: footer}"></div>

    <script th:inline="javascript">
        const receiverId = /*[[${receiver.id}]]*/ 0;
        const senderId = /*[[${sender.id}]]*/ 0;

        document.addEventListener('DOMContentLoaded', function() {
            loadMessages();

            document.getElementById('messageForm').addEventListener('submit', function(e) {
                e.preventDefault();
                sendMessage();
            });
        });

        function loadMessages() {
            fetch(`/api/chats/${receiverId}`, {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(conversation => {
                    const chatBox = document.getElementById('chat-box');
                    chatBox.innerHTML = '';
                    conversation.messages.forEach(message => {
                        appendMessage(message);
                    });

                    if (conversation.otherUserHasLeft) {
                        appendSystemMessage('상대방이 대화를 떠났습니다.');
                        document.getElementById('messageContent').disabled = true;
                        document.querySelector('#messageForm button').disabled = true;
                    }

                    chatBox.scrollTop = chatBox.scrollHeight;
                });
        }

        function sendMessage() {
            const content = document.getElementById('messageContent').value;
            if (!content) return;

            fetch('/api/chats', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ receiverId: receiverId, content: content })
            })
            .then(response => response.json())
            .then(message => {
                appendMessage(message);
                document.getElementById('messageContent').value = '';
                const chatBox = document.getElementById('chat-box');
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        function appendMessage(message) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            
            let alignment = 'received';
            let prefix = `<strong>${message.senderNickname}:</strong> `;
            if (message.senderId === senderId) {
                alignment = 'sent';
                prefix = '';
            }

            messageDiv.classList.add(alignment);
            messageDiv.innerHTML = `<p class="mb-0">${prefix}${message.content}</p><small class="text-muted">${new Date(message.createdAt).toLocaleString()}</small>`;
            chatBox.appendChild(messageDiv);
        }

        function appendSystemMessage(text) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('system-message');
            messageDiv.textContent = text;
            chatBox.appendChild(messageDiv);
        }
    </script>
</body>
</html>
