<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>1:1 대화</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SockJS and STOMP for WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        #chat-box {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
        }

        .message {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }

        .sent {
            justify-content: flex-end;
        }

        .received {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 12px;
        }

        .sent .message-content {
            background-color: #007bff;
            color: white;
        }

        .received .message-content {
            background-color: #e9ecef;
        }

        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .sent .profile-img {
            margin-right: 0;
            margin-left: 10px;
            order: 1;
        }

        .system-message {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 8px;
            margin: 10px 0;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .chat-header img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .deleted-user {
            color: #dc3545;
            font-style: italic;
        }

        .connection-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: auto;
        }

        .connection-status.connected {
            background-color: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .connection-status.connecting {
            background-color: #fff3cd;
            color: #856404;
        }

        /* 다크모드 지원 */
        [data-bs-theme="dark"] .received .message-content {
            background-color: #495057;
            color: #f8f9fa;
        }

        [data-bs-theme="dark"] .received .message-content .text-muted {
            color: #adb5bd !important;
        }

        [data-bs-theme="dark"] #chat-box {
            border-color: #495057;
        }

        [data-bs-theme="dark"] .system-message {
            background-color: #664d03;
            color: #fff3cd;
        }

        [data-bs-theme="dark"] .connection-status.connected {
            background-color: #1e4620;
            color: #75b798;
        }

        [data-bs-theme="dark"] .connection-status.disconnected {
            background-color: #5c1a1a;
            color: #ea868f;
        }

        [data-bs-theme="dark"] .connection-status.connecting {
            background-color: #664d03;
            color: #ffda6a;
        }
    </style>
</head>

<body>
    <div th:replace="~{fragments/layout :: navigation}"></div>

    <div class="container mt-4">
        <div class="chat-header">
            <img th:src="${receiverProfileImage}" alt="프로필">
            <div>
                <h4 th:if="${!receiverDeleted}" th:text="${receiverNickname} + '님과의 대화'">대화</h4>
                <h4 th:if="${receiverDeleted}" class="deleted-user">
                    <i class="bi bi-exclamation-circle"></i> 회원탈퇴를 한 상대방입니다.
                </h4>
            </div>
            <span id="connectionStatus" class="connection-status disconnected">연결 안됨</span>
        </div>

        <div th:if="${receiverDeleted}" class="alert alert-warning">
            <strong>알림:</strong> 이 회원은 탈퇴하여 더 이상 대화를 나눌 수 없습니다.
        </div>

        <div id="chat-box">
            <!-- Messages will be loaded here -->
        </div>
        <form id="messageForm" class="mt-3" th:if="${!receiverDeleted}">
            <div class="input-group">
                <input type="text" id="messageContent" class="form-control" placeholder="메시지 입력..." required>
                <button type="submit" class="btn btn-primary">전송</button>
            </div>
        </form>
    </div>

    <div th:replace="~{fragments/layout :: footer}"></div>

    <script th:inline="javascript">
        const receiverId = /*[[${receiverId}]]*/ 0;
        const senderId = /*[[${sender.id}]]*/ 0;
        const receiverDeleted = /*[[${receiverDeleted}]]*/ false;
        const cacheBuster = '?t=' + new Date().getTime();
        const receiverProfileImage = (/*[[${receiverProfileImage}]]*/ '/profiles/default_profile.png') + cacheBuster;
        const senderProfileImage = (/*[[${senderProfileImage}]]*/ '/profiles/default_profile.png') + cacheBuster;

        let stompClient = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const messageIds = new Set(); // 중복 메시지 방지

        document.addEventListener('DOMContentLoaded', function () {
            loadMessages();
            connectWebSocket();

            const form = document.getElementById('messageForm');
            if (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    sendMessage();
                });
            }
        });

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = 'connection-status ' + status;

            switch (status) {
                case 'connected':
                    statusEl.textContent = '실시간 연결됨';
                    break;
                case 'connecting':
                    statusEl.textContent = '연결 중...';
                    break;
                case 'disconnected':
                    statusEl.textContent = '연결 안됨';
                    break;
            }
        }

        function connectWebSocket() {
            if (receiverDeleted) return;

            updateConnectionStatus('connecting');

            const socket = new SockJS('/ws/chat');
            stompClient = Stomp.over(socket);

            // 디버그 로그 비활성화 (프로덕션에서)
            stompClient.debug = function (str) {
                console.debug(str);
            };

            stompClient.connect({}, function (frame) {
                console.log('WebSocket 연결 성공:', frame);
                isConnected = true;
                reconnectAttempts = 0;
                updateConnectionStatus('connected');

                // Topic 기반 메시지 구독 - 사용자 ID 기반 토픽
                const userTopic = '/topic/chat.user.' + senderId;
                console.log('구독 토픽:', userTopic);

                stompClient.subscribe(userTopic, function (message) {
                    console.log('메시지 수신:', message.body);
                    const chatMessage = JSON.parse(message.body);

                    // 현재 대화 상대의 메시지만 표시
                    if (chatMessage.senderId === receiverId || chatMessage.receiverId === receiverId) {
                        // 중복 메시지 방지
                        if (!messageIds.has(chatMessage.id)) {
                            messageIds.add(chatMessage.id);
                            appendMessage(chatMessage);
                            scrollToBottom();
                        }
                    }
                });

            }, function (error) {
                console.error('WebSocket 연결 실패:', error);
                isConnected = false;
                updateConnectionStatus('disconnected');

                // 재연결 시도
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`재연결 시도 ${reconnectAttempts}/${maxReconnectAttempts}...`);
                    setTimeout(connectWebSocket, 3000 * reconnectAttempts);
                }
            });
        }

        function loadMessages() {
            fetch(`/api/chats/${receiverId}`, {
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('대화를 불러올 수 없습니다.');
                    }
                    return response.json();
                })
                .then(conversation => {
                    const chatBox = document.getElementById('chat-box');
                    chatBox.innerHTML = '';
                    conversation.messages.forEach(message => {
                        messageIds.add(message.id); // 기존 메시지 ID 저장
                        appendMessage(message);
                    });

                    if (conversation.otherUserHasLeft) {
                        appendSystemMessage('상대방이 대화를 떠났습니다.');
                        const contentInput = document.getElementById('messageContent');
                        const submitBtn = document.querySelector('#messageForm button');
                        if (contentInput) contentInput.disabled = true;
                        if (submitBtn) submitBtn.disabled = true;
                    }

                    scrollToBottom();
                })
                .catch(error => {
                    console.error('대화 로드 실패:', error);
                    if (receiverDeleted) {
                        appendSystemMessage('이 회원은 탈퇴하여 이전 대화 내용을 불러올 수 없습니다.');
                    }
                });
        }

        function sendMessage() {
            const content = document.getElementById('messageContent').value.trim();
            if (!content) return;

            // WebSocket 연결 상태에 따라 전송 방식 선택
            if (isConnected && stompClient) {
                // WebSocket으로 전송 (실시간)
                stompClient.send("/app/chat.send", {}, JSON.stringify({
                    receiverId: receiverId,
                    content: content
                }));
                document.getElementById('messageContent').value = '';
            } else {
                // Fallback: REST API로 전송
                sendMessageViaRest(content);
            }
        }

        function sendMessageViaRest(content) {
            fetch('/api/chats', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ receiverId: receiverId, content: content })
            })
                .then(response => response.json())
                .then(message => {
                    if (!messageIds.has(message.id)) {
                        messageIds.add(message.id);
                        appendMessage(message);
                        scrollToBottom();
                    }
                    document.getElementById('messageContent').value = '';
                })
                .catch(error => {
                    console.error('메시지 전송 실패:', error);
                    alert('메시지 전송에 실패했습니다.');
                });
        }

        function appendMessage(message) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.setAttribute('data-message-id', message.id);

            const isSent = message.senderId === senderId;
            messageDiv.classList.add(isSent ? 'sent' : 'received');

            const profileImg = document.createElement('img');
            profileImg.classList.add('profile-img');
            profileImg.src = isSent ? senderProfileImage : (message.senderProfileImage || receiverProfileImage);
            profileImg.alt = '프로필';

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');
            contentDiv.innerHTML = `
                <p class="mb-0">${escapeHtml(message.content)}</p>
                <small class="text-${isSent ? 'light' : 'muted'}">${new Date(message.createdAt).toLocaleString()}</small>
            `;

            if (isSent) {
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(profileImg);
            } else {
                messageDiv.appendChild(profileImg);
                messageDiv.appendChild(contentDiv);
            }

            chatBox.appendChild(messageDiv);
        }

        function appendSystemMessage(text) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('system-message');
            messageDiv.textContent = text;
            chatBox.appendChild(messageDiv);
        }

        function scrollToBottom() {
            const chatBox = document.getElementById('chat-box');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 페이지 떠날 때 WebSocket 연결 해제
        window.addEventListener('beforeunload', function () {
            if (stompClient && isConnected) {
                stompClient.disconnect();
            }
        });
    </script>
</body>

</html>