<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>1:1 ëŒ€í™”</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SockJS and STOMP for WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        #chat-box {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
        }

        .message {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }

        .sent {
            justify-content: flex-end;
        }

        .received {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 12px;
        }

        .sent .message-content {
            background-color: #007bff;
            color: white;
        }

        .received .message-content {
            background-color: #e9ecef;
        }

        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .sent .profile-img {
            margin-right: 0;
            margin-left: 10px;
            order: 1;
        }

        .system-message {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 8px;
            margin: 10px 0;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .chat-header img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .deleted-user {
            color: #dc3545;
            font-style: italic;
        }

        .connection-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: auto;
        }

        .connection-status.connected {
            background-color: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .connection-status.connecting {
            background-color: #fff3cd;
            color: #856404;
        }

        /* ë‹¤í¬ëª¨ë“œ ì§€ì› */
        [data-bs-theme="dark"] .received .message-content {
            background-color: #495057;
            color: #f8f9fa;
        }

        [data-bs-theme="dark"] .received .message-content .text-muted {
            color: #adb5bd !important;
        }

        [data-bs-theme="dark"] #chat-box {
            border-color: #495057;
        }

        [data-bs-theme="dark"] .system-message {
            background-color: #664d03;
            color: #fff3cd;
        }

        [data-bs-theme="dark"] .connection-status.connected {
            background-color: #1e4620;
            color: #75b798;
        }

        [data-bs-theme="dark"] .connection-status.disconnected {
            background-color: #5c1a1a;
            color: #ea868f;
        }

        [data-bs-theme="dark"] .connection-status.connecting {
            background-color: #664d03;
            color: #ffda6a;
        }

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
        }

        .chat-toast {
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .chat-toast .toast-header {
            background-color: #007bff;
            color: white;
            border-bottom: none;
        }

        .chat-toast .toast-header .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        .chat-toast .toast-body {
            padding: 12px;
        }

        .chat-toast .toast-profile {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
        }

        [data-bs-theme="dark"] .chat-toast .toast-header {
            background-color: #0d6efd;
        }

        [data-bs-theme="dark"] .chat-toast .toast-body {
            background-color: #2b3035;
            color: #f8f9fa;
        }

        /* ë©”ì‹œì§€ ì½ìŒ ìƒíƒœ í‘œì‹œ */
        .message-status {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 2px;
            text-align: right;
        }

        [data-bs-theme="dark"] .message-status {
            color: rgba(255, 255, 255, 0.6);
        }
    </style>
</head>

<body>
    <div th:replace="~{fragments/layout :: navigation}"></div>

    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container mt-4">
        <div class="chat-header">
            <img th:src="${receiverProfileImage}" alt="í”„ë¡œí•„">
            <div>
                <h4 th:if="${!receiverDeleted}" th:text="${receiverNickname} + 'ë‹˜ê³¼ì˜ ëŒ€í™”'">ëŒ€í™”</h4>
                <h4 th:if="${receiverDeleted}" class="deleted-user">
                    <i class="bi bi-exclamation-circle"></i> íšŒì›íƒˆí‡´ë¥¼ í•œ ìƒëŒ€ë°©ì…ë‹ˆë‹¤.
                </h4>
            </div>
            <span id="connectionStatus" class="connection-status disconnected">ì—°ê²° ì•ˆë¨</span>
        </div>

        <div th:if="${receiverDeleted}" class="alert alert-warning">
            <strong>ì•Œë¦¼:</strong> ì´ íšŒì›ì€ íƒˆí‡´í•˜ì—¬ ë” ì´ìƒ ëŒ€í™”ë¥¼ ë‚˜ëˆŒ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </div>

        <div id="chat-box">
            <!-- Messages will be loaded here -->
        </div>
        <form id="messageForm" class="mt-3" th:if="${!receiverDeleted}">
            <div class="input-group">
                <input type="text" id="messageContent" class="form-control" placeholder="ë©”ì‹œì§€ ì…ë ¥..." required>
                <button type="submit" class="btn btn-primary">ì „ì†¡</button>
            </div>
        </form>
    </div>

    <div th:replace="~{fragments/layout :: footer}"></div>

    <script th:inline="javascript">
        const receiverId = /*[[${receiverId}]]*/ 0;
        const senderId = /*[[${sender.id}]]*/ 0;
        const receiverDeleted = /*[[${receiverDeleted}]]*/ false;
        const cacheBuster = '?t=' + new Date().getTime();
        const receiverProfileImage = (/*[[${receiverProfileImage}]]*/ '/profiles/default_profile.png') + cacheBuster;
        const senderProfileImage = (/*[[${senderProfileImage}]]*/ '/profiles/default_profile.png') + cacheBuster;

        let stompClient = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const messageIds = new Set(); // ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€
        let isPageVisible = true; // í˜ì´ì§€ ê°€ì‹œì„± ì¶”ì 
        let originalTitle = document.title; // ì›ë³¸ ì œëª© ì €ì¥
        let titleBlinkInterval = null; // ì œëª© ê¹œë¹¡ì„ ì¸í„°ë²Œ

        document.addEventListener('DOMContentLoaded', function () {
            loadMessages();
            connectWebSocket();
            requestNotificationPermission(); // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­

            const form = document.getElementById('messageForm');
            if (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    sendMessage();
                });
            }

            // í˜ì´ì§€ ê°€ì‹œì„± ê°ì§€
            document.addEventListener('visibilitychange', function () {
                isPageVisible = !document.hidden;
                if (isPageVisible) {
                    stopTitleBlink(); // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì´ë©´ ì œëª© ê¹œë¹¡ì„ ì¤‘ì§€
                }
            });

            // í˜ì´ì§€ í¬ì»¤ìŠ¤ ê°ì§€
            window.addEventListener('focus', function () {
                isPageVisible = true;
                stopTitleBlink();
            });

            window.addEventListener('blur', function () {
                isPageVisible = false;
            });
        });

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = 'connection-status ' + status;

            switch (status) {
                case 'connected':
                    statusEl.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
                    break;
                case 'connecting':
                    statusEl.textContent = 'ì—°ê²° ì¤‘...';
                    break;
                case 'disconnected':
                    statusEl.textContent = 'ì—°ê²° ì•ˆë¨';
                    break;
            }
        }

        function connectWebSocket() {
            if (receiverDeleted) return;

            updateConnectionStatus('connecting');

            const socket = new SockJS('/ws/chat');
            stompClient = Stomp.over(socket);

            // ë””ë²„ê·¸ ë¡œê·¸ ë¹„í™œì„±í™” (í”„ë¡œë•ì…˜ì—ì„œ)
            stompClient.debug = function (str) {
                console.debug(str);
            };

            stompClient.connect({}, function (frame) {
                console.log('WebSocket ì—°ê²° ì„±ê³µ:', frame);
                isConnected = true;
                reconnectAttempts = 0;
                updateConnectionStatus('connected');

                // Topic ê¸°ë°˜ ë©”ì‹œì§€ êµ¬ë… - ì‚¬ìš©ì ID ê¸°ë°˜ í† í”½
                const userTopic = '/topic/chat.user.' + senderId;
                console.log('êµ¬ë… í† í”½:', userTopic);

                stompClient.subscribe(userTopic, function (message) {
                    console.log('=== WebSocket ë©”ì‹œì§€ ìˆ˜ì‹  ===');
                    const data = JSON.parse(message.body);
                    console.log('ìˆ˜ì‹  ë°ì´í„°:', data);

                    // ReadStatusDtoì¸ì§€ í™•ì¸ (messageIds í•„ë“œê°€ ìˆìœ¼ë©´ ì½ìŒ ìƒíƒœ)
                    if (data.messageIds) {
                        console.log('âœ… ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸:', data.messageIds);
                        handleReadStatus(data);
                    } else {
                        // ì¼ë°˜ ì±„íŒ… ë©”ì‹œì§€
                        const chatMessage = data;

                        // í˜„ì¬ ëŒ€í™” ìƒëŒ€ì˜ ë©”ì‹œì§€ë§Œ í‘œì‹œ
                        if (chatMessage.senderId === receiverId || chatMessage.receiverId === receiverId) {
                            // ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€
                            if (!messageIds.has(chatMessage.id)) {
                                messageIds.add(chatMessage.id);
                                appendMessage(chatMessage);
                                scrollToBottom();

                                // ë°›ì€ ë©”ì‹œì§€ì¸ ê²½ìš°
                                if (chatMessage.senderId === receiverId) {
                                    showNotification(chatMessage);

                                    // ìë™ ì½ìŒ ì²˜ë¦¬ (ì±„íŒ…ë°©ì´ ì—´ë ¤ìˆìœ¼ë¯€ë¡œ)
                                    markMessageAsReadAuto(chatMessage.id);
                                }
                            }
                        }
                    }
                });

            }, function (error) {
                console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                isConnected = false;
                updateConnectionStatus('disconnected');

                // ì¬ì—°ê²° ì‹œë„
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`ì¬ì—°ê²° ì‹œë„ ${reconnectAttempts}/${maxReconnectAttempts}...`);
                    setTimeout(connectWebSocket, 3000 * reconnectAttempts);
                }
            });
        }

        function loadMessages() {
            fetch(`/api/chats/${receiverId}`, {
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ëŒ€í™”ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    return response.json();
                })
                .then(conversation => {
                    const chatBox = document.getElementById('chat-box');
                    chatBox.innerHTML = '';
                    conversation.messages.forEach(message => {
                        messageIds.add(message.id); // ê¸°ì¡´ ë©”ì‹œì§€ ID ì €ì¥
                        appendMessage(message);
                    });

                    if (conversation.otherUserHasLeft) {
                        appendSystemMessage('ìƒëŒ€ë°©ì´ ëŒ€í™”ë¥¼ ë– ë‚¬ìŠµë‹ˆë‹¤.');
                        const contentInput = document.getElementById('messageContent');
                        const submitBtn = document.querySelector('#messageForm button');
                        if (contentInput) contentInput.disabled = true;
                        if (submitBtn) submitBtn.disabled = true;
                    }

                    scrollToBottom();
                })
                .catch(error => {
                    console.error('ëŒ€í™” ë¡œë“œ ì‹¤íŒ¨:', error);
                    if (receiverDeleted) {
                        appendSystemMessage('ì´ íšŒì›ì€ íƒˆí‡´í•˜ì—¬ ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                });
        }

        function sendMessage() {
            const content = document.getElementById('messageContent').value.trim();
            if (!content) return;

            // WebSocket ì—°ê²° ìƒíƒœì— ë”°ë¼ ì „ì†¡ ë°©ì‹ ì„ íƒ
            if (isConnected && stompClient) {
                // WebSocketìœ¼ë¡œ ì „ì†¡ (ì‹¤ì‹œê°„)
                stompClient.send("/app/chat.send", {}, JSON.stringify({
                    receiverId: receiverId,
                    content: content
                }));
                document.getElementById('messageContent').value = '';
            } else {
                // Fallback: REST APIë¡œ ì „ì†¡
                sendMessageViaRest(content);
            }
        }

        function sendMessageViaRest(content) {
            fetch('/api/chats', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ receiverId: receiverId, content: content })
            })
                .then(response => response.json())
                .then(message => {
                    if (!messageIds.has(message.id)) {
                        messageIds.add(message.id);
                        appendMessage(message);
                        scrollToBottom();
                    }
                    document.getElementById('messageContent').value = '';
                })
                .catch(error => {
                    console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                    alert('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
        }

        function appendMessage(message) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.setAttribute('data-message-id', message.id);

            const isSent = message.senderId === senderId;
            messageDiv.classList.add(isSent ? 'sent' : 'received');

            const profileImg = document.createElement('img');
            profileImg.classList.add('profile-img');
            profileImg.src = isSent ? senderProfileImage : (message.senderProfileImage || receiverProfileImage);
            profileImg.alt = 'í”„ë¡œí•„';

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');

            // ì½ìŒ ìƒíƒœ í‘œì‹œ (ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ë§Œ)
            let statusHtml = '';
            if (isSent && message.readAt == null) {
                statusHtml = '<div class="message-status">1</div>';
            }

            contentDiv.innerHTML = `
                <p class="mb-0">${escapeHtml(message.content)}</p>
                <small class="text-${isSent ? 'light' : 'muted'}">${new Date(message.createdAt).toLocaleString()}</small>
                ${statusHtml}
            `;

            if (isSent) {
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(profileImg);
            } else {
                messageDiv.appendChild(profileImg);
                messageDiv.appendChild(contentDiv);
            }

            chatBox.appendChild(messageDiv);
        }

        function appendSystemMessage(text) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('system-message');
            messageDiv.textContent = text;
            chatBox.appendChild(messageDiv);
        }

        function scrollToBottom() {
            const chatBox = document.getElementById('chat-box');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        function requestNotificationPermission() {
            console.log('========== ì•Œë¦¼ ê¶Œí•œ í™•ì¸ ==========');
            console.log('Notification ì§€ì› ì—¬ë¶€:', 'Notification' in window);

            if ('Notification' in window) {
                console.log('í˜„ì¬ ê¶Œí•œ ìƒíƒœ:', Notification.permission);

                if (Notification.permission === 'default') {
                    console.log('ê¶Œí•œ ìš”ì²­ íŒì—… í‘œì‹œ ì¤‘...');
                    Notification.requestPermission().then(function (permission) {
                        console.log('ì‚¬ìš©ì ì‘ë‹µ:', permission);
                        if (permission === 'granted') {
                            console.log('âœ… ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨!');
                        } else {
                            console.log('âŒ ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨');
                        }
                    });
                } else if (Notification.permission === 'granted') {
                    console.log('âœ… ì•Œë¦¼ ê¶Œí•œ ì´ë¯¸ í—ˆìš©ë˜ì–´ ìˆìŒ');
                } else {
                    console.log('âŒ ì•Œë¦¼ì´ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                    console.log('ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ì™¼ìª½ì˜ ìë¬¼ì‡  ì•„ì´ì½˜ > ì‚¬ì´íŠ¸ ì„¤ì • > ì•Œë¦¼ì„ í—ˆìš©ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.');
                }
            } else {
                console.log('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
            console.log('====================================');
        }

        // ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ
        function showNotification(chatMessage) {
            console.log('========== ì•Œë¦¼ í‘œì‹œ ì‹œë„ ==========');
            console.log('í˜ì´ì§€ ìƒíƒœ - document.hidden:', document.hidden);
            console.log('ë©”ì‹œì§€:', chatMessage);

            // í˜ì´ì§€ê°€ ë°±ê·¸ë¼ìš´ë“œ(ë‹¤ë¥¸ íƒ­)ì¼ ë•Œ: ë¸Œë¼ìš°ì € ì•Œë¦¼
            if (document.hidden) {
                console.log('âœ… í˜ì´ì§€ ë°±ê·¸ë¼ìš´ë“œ - ë¸Œë¼ìš°ì € ì•Œë¦¼ ì‹œë„');

                if ('Notification' in window && Notification.permission === 'granted') {
                    try {
                        const notification = new Notification('ìƒˆ ë©”ì‹œì§€ ë„ì°©', {
                            body: chatMessage.content,
                            icon: receiverProfileImage,
                            badge: receiverProfileImage,
                            tag: 'chat-' + chatMessage.id,
                            requireInteraction: false
                        });

                        notification.onclick = function () {
                            window.focus();
                            notification.close();
                        };

                        setTimeout(() => notification.close(), 3000);
                        console.log('âœ… ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ ì™„ë£Œ');
                    } catch (error) {
                        console.error('âŒ ë¸Œë¼ìš°ì € ì•Œë¦¼ ìƒì„± ì‹¤íŒ¨:', error);
                    }
                } else {
                    console.log('âš ï¸ ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ì—†ìŒ ë˜ëŠ” ë¯¸ì§€ì›');
                }

                // ì œëª© ê¹œë¹¡ì„
                startTitleBlink();
            }
            // í˜ì´ì§€ê°€ ë³´ì´ëŠ” ìƒíƒœ(í˜„ì¬ íƒ­): í† ìŠ¤íŠ¸ ì•Œë¦¼
            else {
                console.log('âœ… í˜ì´ì§€ ë³´ì„ - í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ');
                showToast(chatMessage);
            }
        }

        // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
        function showToast(chatMessage) {
            const toastContainer = document.getElementById('toastContainer');

            // í† ìŠ¤íŠ¸ HTML ìƒì„±
            const toastId = 'toast-' + chatMessage.id + '-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast chat-toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <img src="${receiverProfileImage}" class="toast-profile" alt="í”„ë¡œí•„">
                        <strong class="me-auto">ìƒˆ ë©”ì‹œì§€</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${escapeHtml(chatMessage.content)}
                    </div>
                </div>
            `;

            // í† ìŠ¤íŠ¸ ì¶”ê°€
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);

            // Bootstrap Toast ì´ˆê¸°í™” ë° í‘œì‹œ
            const toastElement = document.getElementById(toastId);

            // Bootstrapì´ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
                const bsToast = new bootstrap.Toast(toastElement, {
                    autohide: true,
                    delay: 4000
                });

                bsToast.show();
                console.log('âœ… í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ ì™„ë£Œ (Bootstrap)');
            } else {
                // Bootstrapì´ ì—†ìœ¼ë©´ ìˆ˜ë™ìœ¼ë¡œ í‘œì‹œ
                toastElement.classList.add('show');
                setTimeout(() => {
                    toastElement.classList.remove('show');
                    setTimeout(() => toastElement.remove(), 150);
                }, 4000);
                console.log('âœ… í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ ì™„ë£Œ (ìˆ˜ë™)');
            }

            // í† ìŠ¤íŠ¸ê°€ ìˆ¨ê²¨ì§„ í›„ DOMì—ì„œ ì œê±°
            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }

        // ì œëª© ê¹œë¹¡ì„ ì‹œì‘
        function startTitleBlink() {
            if (titleBlinkInterval) return; // ì´ë¯¸ ê¹œë¹¡ì´ê³  ìˆìœ¼ë©´ ë¬´ì‹œ

            let isOriginal = true;
            titleBlinkInterval = setInterval(function () {
                document.title = isOriginal ? 'ğŸ’¬ ìƒˆ ë©”ì‹œì§€!' : originalTitle;
                isOriginal = !isOriginal;
            }, 1000);
        }

        // ì œëª© ê¹œë¹¡ì„ ì¤‘ì§€
        function stopTitleBlink() {
            if (titleBlinkInterval) {
                clearInterval(titleBlinkInterval);
                titleBlinkInterval = null;
                document.title = originalTitle;
            }
        }

        // ì½ìŒ ìƒíƒœ ì²˜ë¦¬ í•¨ìˆ˜
        function handleReadStatus(readStatus) {
            console.log('========== ì½ìŒ ìƒíƒœ ì²˜ë¦¬ ==========');
            console.log('ì½ì€ ë©”ì‹œì§€ ID ëª©ë¡:', readStatus.messageIds);

            readStatus.messageIds.forEach(messageId => {
                // DOMì—ì„œ í•´ë‹¹ ë©”ì‹œì§€ì˜ .message-status ì œê±°
                const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageDiv) {
                    const statusDiv = messageDiv.querySelector('.message-status');
                    if (statusDiv) {
                        statusDiv.remove();
                        console.log(`âœ… ë©”ì‹œì§€ ${messageId}ì˜ "1" ì œê±°ë¨`);
                    } else {
                        console.log(`âš ï¸ ë©”ì‹œì§€ ${messageId}ì— .message-status ì—†ìŒ`);
                    }
                } else {
                    console.log(`âš ï¸ ë©”ì‹œì§€ ${messageId} DOMì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                }
            });
        }

        // ìë™ ì½ìŒ ì²˜ë¦¬ í•¨ìˆ˜
        function markMessageAsReadAuto(messageId) {
            fetch(`/api/chats/messages/${messageId}/read`, {
                method: 'POST',
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        console.log(`âœ… ìë™ ì½ìŒ ì²˜ë¦¬ ì™„ë£Œ: messageId=${messageId}`);
                    } else {
                        console.error(`âŒ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨: messageId=${messageId}`);
                    }
                })
                .catch(error => {
                    console.error('ì½ìŒ ì²˜ë¦¬ API ì˜¤ë¥˜:', error);
                });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // í˜ì´ì§€ ë– ë‚  ë•Œ WebSocket ì—°ê²° í•´ì œ
        window.addEventListener('beforeunload', function () {
            if (stompClient && isConnected) {
                stompClient.disconnect();
            }
        });
    </script>
</body>

</html>