<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>내 채팅</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SockJS and STOMP for WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .new-message-badge {
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 8px;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .updated-conversation {
            background-color: #fff3cd !important;
            transition: background-color 0.5s ease;
        }
    </style>
</head>

<body>
    <div th:replace="~{fragments/layout :: navigation}"></div>

    <div class="container mt-4">
        <h2>내 채팅</h2>
        <div id="conversationList" class="list-group">
            <div th:each="conversation : ${conversations}" th:id="${'conversation-' + conversation.otherUserId}"
                th:data-other-user-id="${conversation.otherUserId}"
                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                <a th:href="@{|/chat/${conversation.otherUserId}|}" class="text-decoration-none text-body flex-grow-1">
                    <div class="d-flex align-items-center">
                        <img th:src="${conversation.profileImage != null ? conversation.profileImage : '/profiles/default_profile.png'}"
                            alt="Profile" class="rounded-circle me-3"
                            style="width: 40px; height: 40px; object-fit: cover;">
                        <div class="flex-grow-1">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1" th:text="${conversation.otherUserNickname}"></h5>
                                <small class="last-message-time"
                                    th:text="${#temporals.format(conversation.lastMessageTime, 'yyyy-MM-dd HH:mm')}"></small>
                            </div>
                            <p class="mb-1 last-message-content" th:text="${conversation.lastMessageContent}"></p>
                        </div>
                    </div>
                </a>
                <button class="btn btn-outline-danger btn-sm ms-3"
                    th:onclick="|leaveChat(${conversation.otherUserId})|">나가기</button>
            </div>
            <div th:if="${conversations.isEmpty()}" class="list-group-item">
                <p class="mb-0 text-muted">아직 진행 중인 대화가 없습니다.</p>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/layout :: footer}"></div>

    <script th:inline="javascript">
        const currentUserId = /*[[${currentUserId}]]*/ 0;
        let stompClient = null;

        document.addEventListener('DOMContentLoaded', function () {
            connectWebSocket();
        });

        function connectWebSocket() {
            const socket = new SockJS('/ws/chat');
            stompClient = Stomp.over(socket);

            // 디버그 로그 비활성화
            stompClient.debug = function (str) {
                console.debug(str);
            };

            stompClient.connect({}, function (frame) {
                console.log('채팅 목록 WebSocket 연결 성공');

                // 현재 사용자의 메시지 토픽 구독
                const userTopic = '/topic/chat.user.' + currentUserId;
                console.log('구독 토픽:', userTopic);

                stompClient.subscribe(userTopic, function (message) {
                    const chatMessage = JSON.parse(message.body);
                    console.log('새 메시지 수신:', chatMessage);
                    updateConversationList(chatMessage);
                });
            }, function (error) {
                console.error('WebSocket 연결 실패:', error);
                // 재연결 시도
                setTimeout(connectWebSocket, 5000);
            });
        }

        function updateConversationList(message) {
            // 상대방 ID 결정 (발신자가 나면 수신자가 상대방, 아니면 발신자가 상대방)
            const otherUserId = message.senderId === currentUserId ? message.receiverId : message.senderId;
            const conversationEl = document.getElementById('conversation-' + otherUserId);

            if (conversationEl) {
                // 기존 대화방 업데이트
                const lastMessageEl = conversationEl.querySelector('.last-message-content');
                const lastTimeEl = conversationEl.querySelector('.last-message-time');

                if (lastMessageEl) {
                    lastMessageEl.textContent = message.content;
                }
                if (lastTimeEl) {
                    lastTimeEl.textContent = formatDate(message.createdAt);
                }

                // 하이라이트 효과
                conversationEl.classList.add('updated-conversation');
                setTimeout(() => {
                    conversationEl.classList.remove('updated-conversation');
                }, 3000);

                // 대화방을 목록 맨 위로 이동
                const listGroup = document.getElementById('conversationList');
                listGroup.insertBefore(conversationEl, listGroup.firstChild);
            } else {
                // 새 대화방인 경우 페이지 새로고침
                window.location.reload();
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        function leaveChat(otherUserId) {
            if (!confirm('대화방을 나가시겠습니까? 대화 내역이 사라집니다.')) {
                return;
            }

            fetch(`/api/chats/leave/${otherUserId}`, {
                method: 'POST',
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('대화방 나가기에 실패했습니다.');
                    }
                });
        }

        // 페이지 떠날 때 WebSocket 연결 해제
        window.addEventListener('beforeunload', function () {
            if (stompClient) {
                stompClient.disconnect();
            }
        });
    </script>
</body>

</html>