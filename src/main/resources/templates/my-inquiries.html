<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<head>
    <meta charset="UTF-8">
    <title>내 문의</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>

<body>
    <div th:replace="~{fragments/layout :: navigation}"></div>

    <div class="container mt-4">
        <h2 class="mb-4">
            <i class="bi bi-question-circle me-2"></i>내 문의 내역
        </h2>

        <div id="inquiriesContainer">
            <p class="text-center my-5">로딩 중...</p>
        </div>
    </div>

    <div th:replace="~{fragments/layout :: footer}"></div>

    <script>
        let currentPage = 0;
        const pageSize = 10;

        document.addEventListener('DOMContentLoaded', function () {
            loadMyInquiries(0);
        });

        function loadMyInquiries(page) {
            currentPage = page;

            fetch(`/api/inquiries/my?page=${page}&size=${pageSize}`, {
                credentials: 'include'
            })
                .then(response => {
                    if (response.status === 401) {
                        alert('로그인이 필요합니다.');
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    const container = document.getElementById('inquiriesContainer');

                    if (!data || !data.content || data.content.length === 0) {
                        container.innerHTML = `
                            <div class="alert alert-info text-center">
                                <i class="bi bi-info-circle me-2"></i>
                                제출한 문의가 없습니다.
                            </div>
                        `;
                        return;
                    }

                    const inquiries = data.content;
                    let html = inquiries.map(inq => {
                        const statusBadge = inq.status === 'PENDING'
                            ? '<span class="badge bg-warning">대기 중</span>'
                            : inq.status === 'ANSWERED'
                                ? '<span class="badge bg-success">답변 완료</span>'
                                : '<span class="badge bg-secondary">종료</span>';

                        return `
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">${inq.title}</h5>
                                    ${statusBadge}
                                </div>
                                <div class="card-body">
                                    <p class="card-text" style="white-space: pre-wrap;">${inq.content}</p>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar"></i> ${formatDate(inq.createdAt)}
                                    </small>

                                    ${inq.adminResponse ? `
                                        <hr>
                                        <div class="alert alert-light mb-0">
                                            <h6 class="alert-heading">
                                                <i class="bi bi-person-check-fill me-2"></i>관리자 답변
                                            </h6>
                                            <p class="mb-0" style="white-space: pre-wrap;">${inq.adminResponse}</p>
                                            ${inq.respondedAt ? `
                                                <hr class="my-2">
                                                <small class="text-muted">
                                                    <i class="bi bi-clock"></i> ${formatDate(inq.respondedAt)}
                                                </small>
                                            ` : ''}
                                        </div>
                                    ` : `
                                        <hr>
                                        <p class="text-muted mb-0">
                                            <i class="bi bi-hourglass-split me-2"></i>관리자 답변 대기 중입니다.
                                        </p>
                                    `}
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Add pagination
                    html += renderPagination(data);

                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('inquiriesContainer').innerHTML = `
                        <div class="alert alert-danger text-center">
                            문의 내역을 불러오는데 실패했습니다.
                        </div>
                    `;
                });
        }

        function renderPagination(data) {
            if (data.totalPages <= 1) return '';

            let html = '<nav aria-label="Page navigation" class="mt-4"><ul class="pagination justify-content-center">';

            // Previous button
            html += `<li class="page-item ${data.first ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadMyInquiries(${data.number - 1}); return false;">이전</a>
            </li>`;

            // Page numbers
            const startPage = Math.max(0, data.number - 2);
            const endPage = Math.min(data.totalPages - 1, data.number + 2);

            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === data.number ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadMyInquiries(${i}); return false;">${i + 1}</a>
                </li>`;
            }

            // Next button
            html += `<li class="page-item ${data.last ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadMyInquiries(${data.number + 1}); return false;">다음</a>
            </li>`;

            html += '</ul></nav>';
            return html;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR');
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>