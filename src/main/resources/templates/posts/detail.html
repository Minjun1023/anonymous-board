<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìƒì„¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>

<body>
    <div th:replace="~{fragments/layout :: navigation}"></div>

    <div class="container mt-4">
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="card-title" id="postTitle">ë¡œë”© ì¤‘...</h2>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <small class="text-muted d-flex align-items-center">
                        ì‘ì„±ì: <span id="postNickname" class="ms-1"></span>
                        <div class="dropdown ms-2" id="authorActionsDropdown">
                            <button class="btn btn-sm" type="button" id="authorActions" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                <i class="bi bi-gear"></i>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="authorActions">
                                <li><a class="dropdown-item" id="chatLink" href="#">1:1 ëŒ€í™”</a></li>
                                <li><a class="dropdown-item" id="authorPostsLink" href="#">ì‘ì„±í•œ ê¸€ ì •ë³´</a></li>
                            </ul>
                        </div>
                        <span class="mx-2">|</span>
                        ì‘ì„±ì¼: <span id="postDate"></span>
                        <span class="mx-2">|</span>
                        ì¡°íšŒìˆ˜: <span id="postViewCount"></span>
                    </small>
                    <div id="authorButtons" style="display: none;">
                        <a id="postEditButton" href="#" class="btn btn-outline-primary btn-sm me-1">ìˆ˜ì •</a>
                        <button id="postDeleteButton" onclick="deletePost()"
                            class="btn btn-outline-danger btn-sm">ì‚­ì œ</button>
                    </div>
                </div>

                <div id="imageContainer">
                    <!-- ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                <p class="card-text mt-4" id="postContent" style="white-space: pre-wrap;"></p>

                <!-- íˆ¬í‘œ ì»¨í…Œì´ë„ˆ -->
                <div id="pollContainer" class="mt-4"></div>

                <div class="mt-4 text-center">
                    <button class="btn btn-outline-success me-2" onclick="vote('LIKE')">
                        <i class="bi bi-hand-thumbs-up"></i> ì¶”ì²œ <span id="likesCount">0</span>
                    </button>
                    <button class="btn btn-outline-danger" onclick="vote('DISLIKE')">
                        <i class="bi bi-hand-thumbs-down"></i> ë¹„ì¶”ì²œ <span id="dislikesCount">0</span>
                    </button>
                </div>
            </div>
        </div>
        <hr class="my-0">
        <div class="card-body">
            <h5 class="card-title mb-4">ëŒ“ê¸€ <span id="commentCount" class="badge bg-secondary">0</span></h5>

            <div class="mb-4" sec:authorize="isAuthenticated()">
                <form id="commentForm">
                    <div class="mb-3">
                        <textarea class="form-control" id="commentContent" rows="3" placeholder="ëŒ“ê¸€ ë‚´ìš©"
                            required></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="commentSecret">
                        <label class="form-check-label" for="commentSecret">ë¹„ë°€ ëŒ“ê¸€</label>
                    </div>
                    <button type="submit" class="btn btn-primary">ëŒ“ê¸€ ì‘ì„±</button>
                </form>
            </div>
            <div class="mb-4" sec:authorize="!isAuthenticated()">
                <p class="text-muted small mt-2">* ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/login">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            </div>

            <div id="commentsList">
                <p class="text-center">ë¡œë”© ì¤‘...</p>
            </div>
        </div>
    </div>

    <div class="mt-3">
    </div>

    <div th:replace="~{fragments/layout :: footer}"></div>

    <script>
        const postId = window.location.pathname.split('/').pop();
        let authorId;

        document.addEventListener('DOMContentLoaded', function () {
            loadPost();

            const commentForm = document.getElementById('commentForm');
            if (commentForm) {
                commentForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    addComment();
                });
            }
        });

        function loadPost() {
            fetch('/api/posts/' + postId, {
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) throw new Error('ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return response.json();
                })
                .then(post => {
                    // ê³µì§€ì‚¬í•­ ë°°ì§€ ì¶”ê°€ (ë” ëˆˆì— ë„ê²Œ)
                    const announcementBadge = post.isAnnouncement
                        ? '<span class="badge bg-danger me-2" style="font-size: 1rem; padding: 0.5rem 1rem;"><i class="bi bi-megaphone-fill"></i> ê³µì§€ì‚¬í•­</span>'
                        : '';
                    document.getElementById('postTitle').innerHTML = announcementBadge + post.title;
                    document.getElementById('postContent').textContent = post.content;
                    const profileImage = post.profileImage || '/profiles/default_profile.png';
                    const nicknameHtml = `
                        <div class="d-flex align-items-center">
                            <img src="${profileImage}" alt="Profile" class="rounded-circle me-2" style="width: 24px; height: 24px; object-fit: cover;">
                            <span>${post.nickname}</span>
                        </div>`;
                    document.getElementById('postNickname').innerHTML = nicknameHtml;
                    document.getElementById('postDate').textContent = post.createdAt.substring(0, 16).replace('T', ' ');
                    document.getElementById('postViewCount').textContent = post.viewCount;
                    document.getElementById('likesCount').textContent = post.likes;
                    document.getElementById('dislikesCount').textContent = post.dislikes;
                    authorId = post.authorId;
                    document.getElementById('chatLink').href = `/chat/${authorId}`;
                    document.getElementById('authorPostsLink').href = `/profile/posts?userId=${authorId}`;

                    const imageContainer = document.getElementById('imageContainer');
                    imageContainer.innerHTML = ''; // ê¸°ì¡´ ì´ë¯¸ì§€ ì´ˆê¸°í™”

                    if (post.images && post.images.length > 0) {
                        post.images.forEach(image => {
                            const img = document.createElement('img');
                            img.src = image.url;
                            img.alt = "ê²Œì‹œê¸€ ì´ë¯¸ì§€";
                            img.className = "img-fluid mb-3 rounded d-block"; // mx-auto ì œê±°í•˜ì—¬ ì™¼ìª½ ì •ë ¬
                            img.style.maxHeight = "400px";
                            img.style.width = "auto"; // width 100% ëŒ€ì‹  autoë¡œ ë³€ê²½í•˜ì—¬ ì›ë³¸ ë¹„ìœ¨ ìœ ì§€ (ë„ˆë¬´ í¬ë©´ max-width ì ìš©ë¨)
                            img.style.maxWidth = "100%";
                            img.style.objectFit = "contain";
                            imageContainer.appendChild(img);
                        });
                    }

                    // íˆ¬í‘œ ë Œë”ë§
                    renderPoll(post.poll);

                    if (post.isOwner) {
                        document.getElementById('authorButtons').style.display = 'block';
                        document.getElementById('postEditButton').href = `/posts/${postId}/edit`;
                        document.getElementById('authorActionsDropdown').style.display = 'none';
                    }

                    loadComments();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message);
                    window.location.href = '/posts';
                });
        }

        function renderPoll(poll) {
            const container = document.getElementById('pollContainer');
            container.innerHTML = '';

            if (!poll) return;

            const card = document.createElement('div');
            card.className = 'card mb-4 border-primary';

            const header = document.createElement('div');
            header.className = 'card-header bg-transparent border-primary';
            header.innerHTML = `<h5 class="card-title mb-0">ğŸ“Š ${poll.question}</h5>`;

            const body = document.createElement('div');
            body.className = 'card-body';

            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'd-grid gap-2';

            poll.options.forEach(option => {
                const percent = option.votePercentage.toFixed(1);
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-primary position-relative text-start';
                btn.onclick = () => votePoll(option.id);

                btn.innerHTML = `
                    <div class="d-flex justify-content-between position-relative" style="z-index: 1;">
                        <span>${option.text}</span>
                        <span>${option.voteCount}í‘œ (${percent}%)</span>
                    </div>
                    <div class="position-absolute top-0 start-0 h-100 bg-primary opacity-25" style="width: ${percent}%"></div>
                `;
                optionsDiv.appendChild(btn);
            });

            body.appendChild(optionsDiv);
            card.appendChild(header);
            card.appendChild(body);
            container.appendChild(card);
        }

        function votePoll(optionId) {
            fetch(`/api/posts/${postId}/poll/vote`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ optionId: optionId })
            })
                .then(response => {
                    if (response.status === 401) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        return;
                    }
                    if (response.ok) {
                        loadPost(); // íˆ¬í‘œ í›„ ê°±ì‹ 
                    } else {
                        return response.text().then(text => { throw new Error(text); });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message || 'íˆ¬í‘œ ì‹¤íŒ¨');
                });
        }

        function vote(voteType) {
            fetch('/api/posts/' + postId + '/vote', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ voteType: voteType })
            })
                .then(response => {
                    if (response.status === 401) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        return Promise.reject('UNAUTHORIZED'); // ì—ëŸ¬ ì „íŒŒ ë°©ì§€
                    }
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || 'íˆ¬í‘œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        });
                    }
                    return response.json();
                })
                .then((result) => {
                    if (result && result !== 'UNAUTHORIZED') {
                        loadPost(); // íˆ¬í‘œ í›„ ê²Œì‹œê¸€ ì •ë³´ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                    }
                })
                .catch(error => {
                    if (error !== 'UNAUTHORIZED') {
                        console.error('Error:', error);
                        alert(error.message);
                    }
                });
        }

        function loadComments() {
            fetch('/api/posts/' + postId + '/comments', {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(comments => {
                    const container = document.getElementById('commentsList');
                    document.getElementById('commentCount').textContent = countTotalComments(comments);

                    if (!comments || comments.length === 0) {
                        container.innerHTML = '<p class="text-muted">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        return;
                    }

                    container.innerHTML = comments.map(comment => renderCommentHTML(comment)).join('');
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('commentsList').innerHTML =
                        '<p class="text-danger">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                });
        }

        function countTotalComments(comments) {
            let count = 0;
            for (let comment of comments) {
                count++;
                if (comment.children && comment.children.length > 0) {
                    count += countTotalComments(comment.children);
                }
            }
            return count;
        }

        function renderCommentHTML(comment) {
            const nickname = String(comment.nickname).replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const content = String(comment.content).replace(/</g, '&lt;').replace(/>/g, '&gt;');

            const deleteButton = comment.isOwner ?
                `<button onclick="deleteComment(${comment.id})" class="btn btn-sm btn-outline-danger ms-1">ì‚­ì œ</button>` : '';

            const replyButton = `<button onclick="toggleReplyForm(${comment.id})" class="btn btn-sm btn-outline-secondary ms-1">ë‹µê¸€</button>`;

            let html = `
                <div class="card mb-3" id="comment-${comment.id}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="w-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center">
                                        <img src="${comment.profileImage || '/profiles/default_profile.png'}" alt="Profile" class="rounded-circle me-2" style="width: 24px; height: 24px; object-fit: cover;">
                                        <strong>${nickname}</strong>
                                        ${comment.secret ? '<span class="badge bg-secondary ms-2">ë¹„ë°€</span>' : ''}
                                    </div>
                                    <div>
                                        ${replyButton}
                                        ${deleteButton}
                                    </div>
                                </div>
                                <p class="mb-0 text-break">${content}</p>
                                
                                <!-- ë‹µê¸€ ì‘ì„± í¼ (ìˆ¨ê¹€ ìƒíƒœ) -->
                                <div id="reply-form-${comment.id}" class="mt-3" style="display: none;">
                                    <div class="card card-body bg-light">
                                        <div class="mb-2">
                                            <textarea class="form-control" id="reply-content-${comment.id}" rows="2" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="reply-secret-${comment.id}">
                                                <label class="form-check-label" for="reply-secret-${comment.id}">ë¹„ë°€ê¸€</label>
                                            </div>
                                            <button onclick="addReply(${comment.id})" class="btn btn-sm btn-primary">ë“±ë¡</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;

            // ìì‹ ëŒ“ê¸€(ëŒ€ëŒ“ê¸€)ì´ ìˆëŠ” ê²½ìš° ì¬ê·€ì ìœ¼ë¡œ ë Œë”ë§
            if (comment.children && comment.children.length > 0) {
                html += `<div class="ms-5 border-start ps-3">`; // ë“¤ì—¬ì“°ê¸° ë° êµ¬ë¶„ì„ 
                html += comment.children.map(child => renderCommentHTML(child)).join('');
                html += `</div>`;
            }

            return html;
        }

        function toggleReplyForm(commentId) {
            const form = document.getElementById(`reply-form-${commentId}`);
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }

        function addReply(parentId) {
            const content = document.getElementById(`reply-content-${parentId}`).value;
            const secret = document.getElementById(`reply-secret-${parentId}`).checked;

            if (!content) {
                alert('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            fetch(`/api/posts/${postId}/comments`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content: content,
                    secret: secret,
                    parentId: parentId
                })
            })
                .then(response => {
                    if (response.status === 401 || response.status === 403) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•˜ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                        window.location.href = '/login';
                        return;
                    }
                    if (response.ok) {
                        loadComments(); // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } else {
                        return response.json().then(data => {
                            throw new Error(data.message || 'ë‹µê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message);
                });
        }

        function addComment() {
            const content = document.getElementById('commentContent').value;
            const secret = document.getElementById('commentSecret').checked;

            if (!content) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            fetch('/api/posts/' + postId + '/comments', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: content, secret: secret })
            })
                .then(response => {
                    if (response.status === 401 || response.status === 403) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•˜ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                        window.location.href = '/login';
                        return;
                    }
                    if (response.ok) {
                        document.getElementById('commentForm').reset();
                        loadComments();
                    } else {
                        return response.json().then(data => {
                            throw new Error(data.message || 'ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message);
                });
        }

        function deleteComment(commentId) {
            if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            fetch('/api/comments/' + commentId, {
                method: 'DELETE',
                credentials: 'include'
            })
                .then(response => {
                    if (response.status === 401 || response.status === 403) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•˜ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                        window.location.href = '/login';
                        return;
                    }
                    if (response.ok) {
                        loadComments();
                    } else {
                        return response.json().then(data => {
                            throw new Error(data.message || 'ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message);
                });
        }

        function deletePost() {
            if (!confirm('ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            fetch('/api/posts/' + postId, {
                method: 'DELETE',
                credentials: 'include'
            })
                .then(async response => {
                    if (response.status === 401 || response.status === 403) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•˜ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                        window.location.href = '/login';
                        return;
                    }
                    if (response.ok) {
                        const message = await response.text();
                        alert(message);
                        window.location.href = '/posts';
                    } else {
                        return response.json().then(data => {
                            throw new Error(data.message || 'ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message);
                });
        }
    </script>
</body>

</html>