<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>
<body>
    <div th:replace="~{fragments/layout :: navigation}"></div>

    <div class="container mt-4">
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="card-title" id="postTitle">로딩 중...</h2>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <small class="text-muted d-flex align-items-center">
                        작성자: <span id="postNickname" class="ms-1"></span>
                        <div class="dropdown ms-2" id="authorActionsDropdown">
                            <button class="btn btn-sm" type="button" id="authorActions" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-gear"></i>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="authorActions">
                                <li><a class="dropdown-item" id="chatLink" href="#">1:1 대화</a></li>
                                <li><a class="dropdown-item" id="authorPostsLink" href="#">작성한 글 정보</a></li>
                            </ul>
                        </div>
                        <span class="mx-2">|</span>
                        작성일: <span id="postDate"></span>
                        <span class="mx-2">|</span>
                        조회수: <span id="postViewCount"></span>
                    </small>
                    <button id="postDeleteButton" onclick="deletePost()" class="btn btn-outline-danger btn-sm" style="display: none;">삭제</button>
                </div>
                <p class="card-text" id="postContent"></p>
                <div class="mt-4 text-center">
                    <button class="btn btn-outline-success me-2" onclick="vote('LIKE')">
                        <i class="bi bi-hand-thumbs-up"></i> 추천 <span id="likesCount">0</span>
                    </button>
                    <button class="btn btn-outline-danger" onclick="vote('DISLIKE')">
                        <i class="bi bi-hand-thumbs-down"></i> 비추천 <span id="dislikesCount">0</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">댓글 <span id="commentCount" class="badge bg-secondary">0</span></h5>

                <div class="mb-4" sec:authorize="isAuthenticated()">
                    <form id="commentForm">
                        <div class="mb-3">
                            <textarea class="form-control" id="commentContent" rows="3" placeholder="댓글 내용" required></textarea>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="commentSecret">
                            <label class="form-check-label" for="commentSecret">비밀 댓글</label>
                        </div>
                        <button type="submit" class="btn btn-primary">댓글 작성</button>
                    </form>
                </div>
                <div class="mb-4" sec:authorize="!isAuthenticated()">
                     <p class="text-muted small mt-2">* 댓글을 작성하려면 <a href="/login">로그인</a>이 필요합니다.</p>
                </div>

                <div id="commentsList">
                    <p class="text-center">로딩 중...</p>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <a href="/posts" class="btn btn-secondary">목록으로</a>
        </div>
    </div>

    <div th:replace="~{fragments/layout :: footer}"></div>

    <script>
        const postId = window.location.pathname.split('/').pop();
        let authorId;

        document.addEventListener('DOMContentLoaded', function() {
            loadPost();
            
            const commentForm = document.getElementById('commentForm');
            if(commentForm) {
                commentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addComment();
                });
            }
        });

        function loadPost() {
            fetch('/api/posts/' + postId, {
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) throw new Error('게시글을 찾을 수 없습니다.');
                    return response.json();
                })
                .then(post => {
                    document.getElementById('postTitle').textContent = post.title;
                    document.getElementById('postContent').textContent = post.content;
                    document.getElementById('postNickname').textContent = post.nickname;
                    document.getElementById('postDate').textContent = post.createdAt.substring(0, 16).replace('T', ' ');
                    document.getElementById('postViewCount').textContent = post.viewCount;
                    document.getElementById('likesCount').textContent = post.likes;
                    document.getElementById('dislikesCount').textContent = post.dislikes;
                    authorId = post.authorId;
                    document.getElementById('chatLink').href = `/chat/${authorId}`;
                    document.getElementById('authorPostsLink').href = `/profile/posts?userId=${authorId}`;


                    if (post.isOwner) {
                        document.getElementById('postDeleteButton').style.display = 'block';
                        document.getElementById('authorActionsDropdown').style.display = 'none';
                    }

                    loadComments();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message);
                    window.location.href = '/posts';
                });
        }

        function vote(voteType) {
            fetch('/api/posts/' + postId + '/vote', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ voteType: voteType })
            })
            .then(response => {
                if (response.status === 401) {
                    alert('로그인이 필요합니다.');
                    return Promise.reject('UNAUTHORIZED'); // 에러 전파 방지
                }
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || '투표 처리에 실패했습니다.');
                    });
                }
                return response.text();
            })
            .then((result) => {
                if (result && result !== 'UNAUTHORIZED') {
                    loadPost(); // 투표 후 게시글 정보 다시 로드하여 카운트 업데이트
                }
            })
            .catch(error => {
                if (error !== 'UNAUTHORIZED') {
                    console.error('Error:', error);
                    alert(error.message);
                }
            });
        }

        function loadComments() {
            fetch('/api/posts/' + postId + '/comments', {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(comments => {
                    const container = document.getElementById('commentsList');
                    document.getElementById('commentCount').textContent = comments.length;
                    
                    if (!comments || comments.length === 0) {
                        container.innerHTML = '<p class="text-muted">아직 댓글이 없습니다.</p>';
                        return;
                    }

                    container.innerHTML = comments.map(comment => {
                        const nickname = String(comment.nickname).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const content = String(comment.content).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const deleteButton = comment.isOwner ?
                            `<button onclick="deleteComment(${comment.id})" class="btn btn-sm btn-outline-danger">삭제</button>` : '';

                        return '<div class="card mb-3" id="comment-' + comment.id + '">' +
                            '<div class="card-body">' +
                                '<div class="d-flex justify-content-between align-items-start">' +
                                    '<div>' +
                                        '<strong>' + nickname + '</strong>' +
                                        (comment.secret ? ' <span class="badge bg-secondary">비밀</span>' : '') +
                                        '<p class="mb-0 mt-2">' + content + '</p>' +
                                    '</div>' +
                                    '<div>' + deleteButton + '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
                    }).join('');
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('commentsList').innerHTML = 
                        '<p class="text-danger">댓글을 불러오는데 실패했습니다.</p>';
                });
        }

        function addComment() {
            const content = document.getElementById('commentContent').value;
            const secret = document.getElementById('commentSecret').checked;

            if (!content) {
                alert('댓글 내용을 입력해주세요.');
                return;
            }

            fetch('/api/posts/' + postId + '/comments', {
                method: 'POST',
                credentials: 'include',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: content, secret: secret })
            })
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    alert('로그인이 필요하거나 권한이 없습니다.');
                    window.location.href = '/login';
                    return;
                }
                if (response.ok) {
                    document.getElementById('commentForm').reset();
                    loadComments();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || '댓글 작성에 실패했습니다.');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
        }

        function deleteComment(commentId) {
            if (!confirm('댓글을 삭제하시겠습니까?')) return;

            fetch('/api/comments/' + commentId, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    alert('로그인이 필요하거나 권한이 없습니다.');
                    window.location.href = '/login';
                    return;
                }
                if (response.ok) {
                    loadComments();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || '댓글 삭제에 실패했습니다.');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
        }

        function deletePost() {
            if (!confirm('게시글을 삭제하시겠습니까?')) return;

            fetch('/api/posts/' + postId, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    alert('로그인이 필요하거나 권한이 없습니다.');
                    window.location.href = '/login';
                    return;
                }
                if (response.ok) {
                    alert('게시글이 삭제되었습니다.');
                    window.location.href = '/posts';
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || '게시글 삭제에 실패했습니다.');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
        }
    </script>
</body>
</html>
