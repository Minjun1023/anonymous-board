<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .write-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">익명 게시판</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/posts">게시글 목록</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container write-container">
        <h2 class="mb-4">게시글 수정</h2>

        <form id="editForm">
            <div class="mb-3">
                <label for="title" class="form-label">제목</label>
                <input type="text" class="form-control" id="title" required>
            </div>

            <div class="mb-3">
                <label for="content" class="form-label">내용</label>
                <textarea class="form-control" id="content" rows="10" required></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">기존 이미지 (삭제할 이미지를 선택하세요)</label>
                <div id="existingImages" class="d-flex flex-wrap gap-3 mb-2">
                    <!-- 기존 이미지가 여기에 동적으로 추가됩니다 -->
                </div>
            </div>

            <div class="mb-3">
                <label for="file" class="form-label">이미지 추가 (기존 이미지는 유지되며, 추가로 업로드됩니다)</label>
                <input type="file" class="form-control" id="file" accept="image/*" multiple onchange="updateFileList()">
                <div id="fileList" class="mt-2 text-muted small"></div>
            </div>

            <!-- 투표 섹션 -->
            <div class="mb-3 form-check" id="pollCheckboxContainer">
                <input type="checkbox" class="form-check-input" id="usePoll" onchange="togglePoll()">
                <label class="form-check-label" for="usePoll">투표 추가</label>
            </div>
            <div id="pollSection" style="display: none;" class="card p-3 mb-3">
                <div class="mb-3">
                    <label for="pollQuestion" class="form-label">투표 질문</label>
                    <input type="text" class="form-control" id="pollQuestion" placeholder="질문을 입력하세요">
                </div>
                <div id="pollOptions">
                    <div class="mb-2">
                        <input type="text" class="form-control poll-option" placeholder="항목 1">
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control poll-option" placeholder="항목 2">
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addPollOption()">+ 항목
                    추가</button>
            </div>

            <div class="d-flex justify-content-end gap-2">
                <a href="javascript:history.back()" class="btn btn-secondary">취소</a>
                <button type="submit" class="btn btn-primary">수정완료</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function updateFileList() {
            const fileInput = document.getElementById('file');
            const fileList = document.getElementById('fileList');

            if (fileInput.files.length === 0) {
                fileList.textContent = '';
                return;
            }

            let fileNames = [];
            for (let i = 0; i < fileInput.files.length; i++) {
                fileNames.push(fileInput.files[i].name);
            }
            fileList.textContent = '선택된 파일: ' + fileNames.join(', ');
        }

        function togglePoll() {
            const pollSection = document.getElementById('pollSection');
            const usePoll = document.getElementById('usePoll');
            pollSection.style.display = usePoll.checked ? 'block' : 'none';
        }

        function addPollOption() {
            const container = document.getElementById('pollOptions');
            const count = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'mb-2';
            div.innerHTML = `<input type="text" class="form-control poll-option" placeholder="항목 ${count}">`;
            container.appendChild(div);
        }

        document.addEventListener('DOMContentLoaded', function () {
            // 커스텀 검증 메시지 설정
            const titleInput = document.getElementById('title');
            const contentInput = document.getElementById('content');

            titleInput.oninvalid = function (e) {
                e.target.setCustomValidity('제목을 입력해주세요.');
            };
            titleInput.oninput = function (e) {
                e.target.setCustomValidity('');
            };

            contentInput.oninvalid = function (e) {
                e.target.setCustomValidity('내용을 입력해주세요.');
            };
            contentInput.oninput = function (e) {
                e.target.setCustomValidity('');
            };

            const pathParts = window.location.pathname.split('/');
            const postId = pathParts[2]; // /posts/{id}/edit

            // 게시글 데이터 로드
            fetch(`/api/posts/${postId}`, {
                headers: getHeaders()
            })
                .then(response => {
                    if (!response.ok) throw new Error('게시글을 불러올 수 없습니다.');
                    return response.json();
                })
                .then(post => {
                    document.getElementById('title').value = post.title;
                    document.getElementById('content').value = post.content;

                    // 기존 이미지 렌더링
                    const existingImagesContainer = document.getElementById('existingImages');
                    existingImagesContainer.innerHTML = '';
                    if (post.images && post.images.length > 0) {
                        post.images.forEach(image => {
                            const div = document.createElement('div');
                            div.className = 'position-relative';
                            div.style.width = '150px';

                            const img = document.createElement('img');
                            img.src = image.url;
                            img.className = 'img-thumbnail';
                            img.style.width = '100%';
                            img.style.height = '150px';
                            img.style.objectFit = 'cover';

                            const checkboxDiv = document.createElement('div');
                            checkboxDiv.className = 'form-check mt-1 text-center';

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.className = 'form-check-input delete-image-checkbox';
                            checkbox.value = image.id;
                            checkbox.id = `delete-img-${image.id}`;

                            const label = document.createElement('label');
                            label.className = 'form-check-label small text-danger';
                            label.htmlFor = `delete-img-${image.id}`;
                            label.textContent = '삭제';

                            checkboxDiv.appendChild(checkbox);
                            checkboxDiv.appendChild(label);

                            div.appendChild(img);
                            div.appendChild(checkboxDiv);
                            existingImagesContainer.appendChild(div);
                        });
                    } else {
                        existingImagesContainer.innerHTML = '<p class="text-muted small">첨부된 이미지가 없습니다.</p>';
                    }

                    // 기존 투표 확인 - 투표가 이미 있으면 투표 추가 불가
                    if (post.poll) {
                        const pollCheckbox = document.getElementById('usePoll');
                        const pollLabel = document.querySelector('label[for="usePoll"]');
                        pollCheckbox.disabled = true;
                        pollCheckbox.checked = false;
                        pollLabel.innerHTML = '투표 추가 <span class="text-muted small">(이미 투표가 존재합니다)</span>';
                    }
                })
                .catch(error => {
                    alert(error.message);
                    window.location.href = '/posts';
                });

            // 수정 폼 제출
            document.getElementById('editForm').addEventListener('submit', function (e) {
                e.preventDefault();

                const deleteImageIds = Array.from(document.querySelectorAll('.delete-image-checkbox:checked'))
                    .map(cb => parseInt(cb.value));

                // 투표 데이터 검증 및 추가
                const usePoll = document.getElementById('usePoll');
                let pollData = {};

                if (usePoll.checked) {
                    const question = document.getElementById('pollQuestion').value;
                    const options = Array.from(document.querySelectorAll('.poll-option'))
                        .map(input => input.value)
                        .filter(val => val.trim() !== '');

                    if (!question) {
                        alert('투표 질문을 입력해주세요.');
                        return;
                    }
                    if (options.length < 2) {
                        alert('투표 항목은 최소 2개 이상 입력해야 합니다.');
                        return;
                    }

                    pollData.pollQuestion = question;
                    pollData.pollOptions = options;
                }

                const formData = new FormData();
                const postData = {
                    title: document.getElementById('title').value,
                    content: document.getElementById('content').value,
                    deleteImageIds: deleteImageIds,
                    ...pollData
                };

                formData.append('post', new Blob([JSON.stringify(postData)], { type: 'application/json' }));

                const fileInput = document.getElementById('file');
                if (fileInput.files.length > 0) {
                    for (let i = 0; i < fileInput.files.length; i++) {
                        formData.append('files', fileInput.files[i]);
                    }
                }

                fetch(`/api/posts/${postId}`, {
                    method: 'PUT',
                    headers: getHeaders(null), // Content-Type 자동 설정을 위해 null 전달
                    body: formData
                })
                    .then(async response => {
                        if (response.ok) {
                            const data = await response.json();
                            alert(data.message || '게시글이 수정되었습니다.');
                            window.location.href = `/posts/${postId}`;
                        } else {
                            return response.json().then(data => {
                                throw new Error(data.message || '게시글 수정에 실패했습니다.')
                            });
                        }
                    })
                    .catch(error => {
                        alert(error.message || '게시글 수정에 실패했습니다.');
                    });
            });

            function getHeaders(contentType = 'application/json') {
                const headers = {};
                if (contentType) {
                    headers['Content-Type'] = contentType;
                }

                const token = localStorage.getItem('jwtToken');
                if (token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }
                return headers;
            }
        });
    </script>
</body>

</html>