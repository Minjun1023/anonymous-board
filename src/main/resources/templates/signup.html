<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div th:replace="~{fragments/layout :: navigation}"></div>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>회원가입</h3>
                    </div>
                    <div class="card-body">

                        <!-- Step 1: Email Verification -->
                        <div id="emailStep">
                            <form id="emailForm">
                                <div class="mb-3">
                                    <label for="email" class="form-label">이메일</label>
                                    <input type="email" class="form-control" id="email" required>
                                    <div class="invalid-feedback">이미 사용 중인 이메일입니다.</div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">인증 코드 발송</button>
                            </form>
                        </div>

                        <!-- Step 2: Code Verification -->
                        <div id="verifyStep" style="display: none;">
                            <p><strong id="emailDisplay"></strong> (으)로 전송된 인증 코드를 입력해주세요.</p>
                            <form id="verifyForm">
                                <div class="mb-3">
                                    <label for="verificationCode" class="form-label">인증 코드</label>
                                    <input type="text" class="form-control" id="verificationCode" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">인증 확인</button>
                            </form>
                        </div>

                        <!-- Step 3: User Details -->
                        <div id="detailsStep" style="display: none;">
                            <form id="signupForm">
                                <div class="mb-3">
                                    <label for="signupEmail" class="form-label">이메일</label>
                                    <input type="email" class="form-control" id="signupEmail" disabled>
                                </div>
                                <div class="mb-3">
                                    <label for="username" class="form-label">아이디</label>
                                    <input type="text" class="form-control" id="username" required>
                                    <div class="invalid-feedback" id="username-invalid-feedback">아이디는 4~12자의 영문 소문자, 숫자로만 입력해주세요.</div>
                                    <div class="valid-feedback">사용 가능한 아이디입니다.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="nickname" class="form-label">닉네임</label>
                                    <input type="text" class="form-control" id="nickname" required>
                                    <div class="invalid-feedback" id="nickname-invalid-feedback">닉네임은 2~10자의 한글, 영문, 숫자로만 입력해주세요.</div>
                                    <div class="valid-feedback">사용 가능한 닉네임입니다.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">비밀번호</label>
                                    <input type="password" class="form-control" id="password" required>
                                    <div class="invalid-feedback">비밀번호는 8~16자의 영문 대소문자, 숫자, 특수문자를 포함해야 합니다.</div>
                                    <small class="form-text text-muted">8~16자 영문 대소문자, 숫자, 특수문자를 사용하세요.</small>
                                </div>
                                <div class="mb-3">
                                    <label for="passwordConfirm" class="form-label">비밀번호 확인</label>
                                    <input type="password" class="form-control" id="passwordConfirm" required>
                                    <div class="invalid-feedback">비밀번호가 일치하지 않습니다.</div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">회원가입</button>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/layout :: footer}"></div>

    <script>
        const emailStep = document.getElementById('emailStep');
        const verifyStep = document.getElementById('verifyStep');
        const detailsStep = document.getElementById('detailsStep');

        const emailForm = document.getElementById('emailForm');
        const verifyForm = document.getElementById('verifyForm');
        const signupForm = document.getElementById('signupForm');

        const emailInput = document.getElementById('email');
        const usernameInput = document.getElementById('username');
        const nicknameInput = document.getElementById('nickname');
        const passwordInput = document.getElementById('password');
        const passwordConfirmInput = document.getElementById('passwordConfirm');

        const usernameRegex = new RegExp("^[a-z0-9]{4,12}$");
        const passwordRegex = new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*#?&])[A-Za-z\\d@$!%*#?&]{8,16}$");
        const nicknameRegex = new RegExp("^[ㄱ-ㅎ가-힣a-zA-Z0-9]{2,10}$");

        // Step 1: Send verification code
        emailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;

            // Check if email exists
            const emailExistsResponse = await fetch(`/api/users/check-email?email=${email}`);
            const emailExistsData = await emailExistsResponse.json();
            if (emailExistsData.exists) {
                emailInput.classList.add('is-invalid');
                return;
            }
            emailInput.classList.remove('is-invalid');

            try {
                const response = await fetch('/api/email/send-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });
                if (!response.ok) throw new Error('인증 코드 발송에 실패했습니다.');
                
                alert('인증 코드가 발송되었습니다. 이메일을 확인해주세요.');
                document.getElementById('emailDisplay').textContent = email;
                document.getElementById('signupEmail').value = email;
                emailStep.style.display = 'none';
                verifyStep.style.display = 'block';
            } catch (error) {
                alert(error.message);
            }
        });

        // Step 2: Verify code
        verifyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const token = document.getElementById('verificationCode').value;

            try {
                const response = await fetch('/api/email/check-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, token: token })
                });
                if (!response.ok) throw new Error('인증 코드가 올바르지 않습니다.');

                alert('이메일 인증이 완료되었습니다.');
                verifyStep.style.display = 'none';
                detailsStep.style.display = 'block';
            } catch (error) {
                alert(error.message);
            }
        });

        // Step 3: Validation
        usernameInput.addEventListener('keyup', () => {
            const username = usernameInput.value;
            if (!usernameRegex.test(username)) {
                usernameInput.classList.remove('is-valid');
                usernameInput.classList.add('is-invalid');
                document.getElementById('username-invalid-feedback').textContent = '아이디는 4~12자의 영문 소문자, 숫자로만 입력해주세요.';
            } else {
                usernameInput.classList.remove('is-invalid');
            }
        });

        usernameInput.addEventListener('blur', async () => {
            const username = usernameInput.value;
            if (!usernameRegex.test(username)) return;

            const response = await fetch(`/api/users/check-username?username=${username}`);
            const data = await response.json();

            if (data.exists) {
                usernameInput.classList.remove('is-valid');
                usernameInput.classList.add('is-invalid');
                document.getElementById('username-invalid-feedback').textContent = '이미 사용 중인 아이디입니다.';
            } else {
                usernameInput.classList.remove('is-invalid');
                usernameInput.classList.add('is-valid');
            }
        });

        nicknameInput.addEventListener('keyup', () => {
            const nickname = nicknameInput.value;
            if (!nicknameRegex.test(nickname)) {
                nicknameInput.classList.remove('is-valid');
                nicknameInput.classList.add('is-invalid');
                document.getElementById('nickname-invalid-feedback').textContent = '닉네임은 2~10자의 한글, 영문, 숫자로만 입력해주세요.';
            } else {
                nicknameInput.classList.remove('is-invalid');
            }
        });

        nicknameInput.addEventListener('blur', async () => {
            const nickname = nicknameInput.value;
            if (!nicknameRegex.test(nickname)) return;

            const response = await fetch(`/api/users/check-nickname?nickname=${nickname}`);
            const data = await response.json();

            if (data.exists) {
                nicknameInput.classList.remove('is-valid');
                nicknameInput.classList.add('is-invalid');
                document.getElementById('nickname-invalid-feedback').textContent = '이미 사용 중인 닉네임입니다.';
            } else {
                nicknameInput.classList.remove('is-invalid');
                nicknameInput.classList.add('is-valid');
            }
        });

        passwordInput.addEventListener('keyup', () => {
            if (!passwordRegex.test(passwordInput.value)) {  
                passwordInput.classList.add('is-invalid');
            } else {
                passwordInput.classList.remove('is-invalid');
            }
        });

        passwordConfirmInput.addEventListener('keyup', () => {
            if (passwordInput.value !== passwordConfirmInput.value) {
                passwordConfirmInput.classList.add('is-invalid');
            } else {
                passwordConfirmInput.classList.remove('is-invalid');
            }
        });

        // Final Signup
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Final validation checks
            if (!usernameRegex.test(usernameInput.value) || usernameInput.classList.contains('is-invalid')) {
                alert('아이디가 유효하지 않거나 중복됩니다.');
                return;
            }
            if (!nicknameRegex.test(nicknameInput.value) || nicknameInput.classList.contains('is-invalid')) {
                alert('닉네임이 유효하지 않거나 중복됩니다.');
                return;
            }
            if (!passwordRegex.test(passwordInput.value)) {
                alert('비밀번호가 유효하지 않습니다.');
                return;
            }
            if (passwordInput.value !== passwordConfirmInput.value) {
                alert('비밀번호가 일치하지 않습니다.');
                return;
            }

            const signupData = {
                username: usernameInput.value,
                email: document.getElementById('signupEmail').value,
                password: passwordInput.value,
                nickname: nicknameInput.value
            };

            try {
                const response = await fetch('/api/users/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(signupData)
                });

                if (response.ok) {
                    alert('회원가입이 완료되었습니다. 로그인 페이지로 이동합니다.');
                    window.location.href = '/login';
                } else {
                    // 응답이 JSON인지 확인
                    const contentType = response.headers.get('content-type');
                    let message = '회원가입에 실패했습니다.';
                    
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        message = errorData.message || errorData.error || message;
                    } else {
                        const errorText = await response.text();
                        console.error('Server error:', errorText);
                        message = '서버 오류가 발생했습니다.';
                    }
                    
                    alert(message);
                }
            } catch (error) {
                console.error('Signup error:', error);
                alert('회원가입 중 오류가 발생했습니다: ' + error.message);
            }
        });

    </script>
</body>
</html>
